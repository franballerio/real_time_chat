<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Whatsapp 2</title>

  <link rel='preconnect' href='https://fonts.googleapis.com'>
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
  <link href='https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap'
        rel='stylesheet'>
  <style>
    /* Your existing CSS goes here */
    *, *::before, *::after { box-sizing: border-box; }
    :root { color-scheme: light dark; }
    body {
        margin: 0;
        font-family: 'Roboto', sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }
    .container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100vh;
    }
    #messages { list-style-type: none; margin: 0; padding: 0; overflow-y: scroll; height: 100%; scroll-behavior: smooth; padding-bottom: 48px; }
    #messages > li { padding: .5rem 1rem; }
    #messages > li:nth-child(odd) { background: #eee; }
    #chat { border: 1px solid #ccc; border-radius: 8px; overflow: hidden; width: 350px; height: 80vh; position: relative; }
    #form { bottom: 0; display: flex; height: 48px; left: 0; padding: 4px; position: absolute; right: 0; }
    #input { border-radius: 9999px; border: 1px solid #eee; flex: 1; margin: 4px; padding: 0 8px; }
    #input:focus { outline: 0; }
    #form > button { background: #09f; color: #fff; border: 0; margin: 4px; border-radius: 4px; }
    #form > button:hover { background: #0cf; }
  </style>

  <script type='module'>
    import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js';

    // Properly inject server-side userData into client-side JavaScript
    const userData = {
      email: '<%= email %>',
      user_name: '<%= user_name %>'
    };
    
    console.log('User data:', userData);
    
    // Wait for the page to load before running the script
    document.addEventListener('DOMContentLoaded', () => {
      
      // if (!userData) {
      //   // If user is not logged in, redirect to the home/login page
      //   window.location.href = '/';
      //   return;
      // }


      const socket = io({
        auth: {
          // 3. Use the username from the injected userData object
          user_name: userData.user_name,
          serverOffset: 0,
        }
      });

      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');
      const logout = document.getElementById('logout');

      socket.on('chat message', (msg, user_name) => {
          const item = `<li><strong>${user_name}:</strong> ${msg}</li>`;
          messages.insertAdjacentHTML('beforeend', item);
          socket.auth.serverOffset = serverOffset;
          messages.scrollTop = messages.scrollHeight;
      });

      form.addEventListener('submit', (e) => {
          e.preventDefault();

          if (input.value) {
              // 4. Use the authenticated username when emitting a message
              socket.emit('chat message', input.value, userData.user_name);
              console.log(`Mensaje enviado por ${userData.user_name}`)
              input.value = '';
          }
      });

      logout.addEventListener('click', (e) => {
        e.preventDefault();

        fetch('/logout', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          }
        })
        .then(res => {
            console.log(res)
            window.location.href = ('/')
        })
      })
    });
  </script>
</head>

<body>
  <section id='chat'>
    <ul id='messages'></ul>
    <form id='form'>
      <input type='text' name='message' id='input' placeholder='Type a message' autocomplete='off' />
      <button type='submit'>Enviar</button>
    </form>
  </section>
  <button id='logout'>logout</button>
</body>

</html>